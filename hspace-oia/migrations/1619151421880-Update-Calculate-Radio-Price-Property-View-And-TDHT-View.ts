import {MigrationInterface, QueryRunner} from "typeorm";

export class UpdateCalculateRadioPricePropertyViewAndTDHTView1619151421880 implements MigrationInterface {
    name = "UpdateCalculateRadioPricePropertyViewAndTDHTView1619151421880"

    public async up(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query("DELETE FROM \"typeorm_metadata\" WHERE \"type\" = 'VIEW' AND \"schema\" = $1 AND \"name\" = $2", ["public","appraisal_statement_ratio_view"]);
        await queryRunner.query("DROP MATERIALIZED VIEW \"appraisal_statement_ratio_view\"");
        await queryRunner.query("DELETE FROM \"typeorm_metadata\" WHERE \"type\" = 'VIEW' AND \"schema\" = $1 AND \"name\" = $2", ["public","property_ratio_view"]);
        await queryRunner.query("DROP MATERIALIZED VIEW \"property_ratio_view\" CASCADE");    
        
        await queryRunner.query("CREATE MATERIALIZED VIEW \"property_ratio_view\" AS SELECT \"property\".\"id\" AS \"id\", \"property\".\"closed_deal_value\" AS \"closed_deal_value\", \"property\".\"changeable_price\" AS \"changeable_price\", \"latestApprovedTH\".\"ref_id\" AS \"appraisal_statement_id\", \"latestApprovedHD\".\"ref_id\" AS \"investment_efficiency_id\", \"appraisalStatement\".\"property_unit_price_ppss\" AS \"property_unit_price_ppss\", \"investmentEfficiency\".\"approved_purchase_price\" AS \"approved_purchase_price\", changeable_price - approved_purchase_price AS \"difference_price\", CAST(changeable_price AS float)/NULLIF(CAST(approved_purchase_price AS float),0) AS \"ratio_changeable_buy\", CAST(changeable_price AS float)/NULLIF(CAST(property_unit_price_ppss AS float),0) AS \"ratio_changeable_appraise\", ABS(CAST(closed_deal_value AS float) - CAST(property_unit_price_ppss AS float)) / NULLIF(CAST(closed_deal_value AS float),0) AS \"ratio_closed_deal_appraise\" FROM \"properties\" \"property\" LEFT JOIN \"latest_approved_notes\" \"latestApprovedTH\" ON \"latestApprovedTH\".\"type\" = 'TH' AND \"latestApprovedTH\".\"property_id\" = \"property\".\"id\"  LEFT JOIN \"latest_approved_notes\" \"latestApprovedHD\" ON \"latestApprovedHD\".\"type\" = 'HD' AND \"latestApprovedHD\".\"property_id\" = \"property\".\"id\"  LEFT JOIN \"appraisal_statement_notes\" \"appraisalStatement\" ON \"appraisalStatement\".\"id\" = \"latestApprovedTH\".\"ref_id\"  LEFT JOIN \"investment_efficiency_notes\" \"investmentEfficiency\" ON \"investmentEfficiency\".\"id\" = \"latestApprovedHD\".\"ref_id\" WHERE \"property\".\"is_active\" = true");
        await queryRunner.query("INSERT INTO \"typeorm_metadata\"(\"type\", \"schema\", \"name\", \"value\") VALUES ($1, $2, $3, $4)", ["VIEW","public","property_ratio_view","SELECT \"property\".\"id\" AS \"id\", \"property\".\"closed_deal_value\" AS \"closed_deal_value\", \"property\".\"changeable_price\" AS \"changeable_price\", \"latestApprovedTH\".\"ref_id\" AS \"appraisal_statement_id\", \"latestApprovedHD\".\"ref_id\" AS \"investment_efficiency_id\", \"appraisalStatement\".\"property_unit_price_ppss\" AS \"property_unit_price_ppss\", \"investmentEfficiency\".\"approved_purchase_price\" AS \"approved_purchase_price\", changeable_price - approved_purchase_price AS \"difference_price\", CAST(changeable_price AS float)/NULLIF(CAST(approved_purchase_price AS float),0) AS \"ratio_changeable_buy\", CAST(changeable_price AS float)/NULLIF(CAST(property_unit_price_ppss AS float),0) AS \"ratio_changeable_appraise\", ABS(CAST(closed_deal_value AS float) - CAST(property_unit_price_ppss AS float)) / NULLIF(CAST(closed_deal_value AS float),0) AS \"ratio_closed_deal_appraise\" FROM \"properties\" \"property\" LEFT JOIN \"latest_approved_notes\" \"latestApprovedTH\" ON \"latestApprovedTH\".\"type\" = 'TH' AND \"latestApprovedTH\".\"property_id\" = \"property\".\"id\"  LEFT JOIN \"latest_approved_notes\" \"latestApprovedHD\" ON \"latestApprovedHD\".\"type\" = 'HD' AND \"latestApprovedHD\".\"property_id\" = \"property\".\"id\"  LEFT JOIN \"appraisal_statement_notes\" \"appraisalStatement\" ON \"appraisalStatement\".\"id\" = \"latestApprovedTH\".\"ref_id\"  LEFT JOIN \"investment_efficiency_notes\" \"investmentEfficiency\" ON \"investmentEfficiency\".\"id\" = \"latestApprovedHD\".\"ref_id\" WHERE \"property\".\"is_active\" = true"]);
        await queryRunner.query("CREATE MATERIALIZED VIEW \"appraisal_statement_ratio_view\" AS SELECT \"appraisalStatement\".\"id\" AS \"id\", \"appraisalStatement\".\"property_id\" AS \"property_id\", ABS(CAST(closed_deal_value AS float) - CAST(property_unit_price_ppss AS float)) / NULLIF(CAST(closed_deal_value AS float),0) AS \"ratio_closed_deal_appraise\" FROM \"appraisal_statement_notes\" \"appraisalStatement\" LEFT JOIN \"properties\" \"property\" ON \"property\".\"id\" = \"appraisalStatement\".\"property_id\" WHERE \"appraisalStatement\".\"status\" IN ('Đã duyệt', 'Đã xoá')");
        await queryRunner.query("INSERT INTO \"typeorm_metadata\"(\"type\", \"schema\", \"name\", \"value\") VALUES ($1, $2, $3, $4)", ["VIEW","public","appraisal_statement_ratio_view","SELECT \"appraisalStatement\".\"id\" AS \"id\", \"appraisalStatement\".\"property_id\" AS \"property_id\", ABS(CAST(closed_deal_value AS float) - CAST(property_unit_price_ppss AS float)) / NULLIF(CAST(closed_deal_value AS float),0) AS \"ratio_closed_deal_appraise\" FROM \"appraisal_statement_notes\" \"appraisalStatement\" LEFT JOIN \"properties\" \"property\" ON \"property\".\"id\" = \"appraisalStatement\".\"property_id\" WHERE \"appraisalStatement\".\"status\" IN ('Đã duyệt', 'Đã xoá')"]);
        await queryRunner.query("CREATE VIEW \"property_view\" AS SELECT \"property\".\"id\" AS \"id\", \"property\".\"created_at\" AS \"created_at\", \"property\".\"updated_at\" AS \"updated_at\", \"property\".\"street_number\" AS \"street_number\", \"property\".\"price\" AS \"price\", \"property\".\"city_id\" AS \"city_id\", \"property\".\"ward_id\" AS \"ward_id\", \"property\".\"district_id\" AS \"district_id\", \"property\".\"street_id\" AS \"street_id\", \"property\".\"urgent_level_id\" AS \"urgent_level_id\", \"property\".\"recognized_area\" AS \"recognized_area\", \"property\".\"business_status\" AS \"business_status\", \"property\".\"status\" AS \"status\", \"property\".\"code\" AS \"code\", \"property\".\"broker_id\" AS \"broker_id\", \"property\".\"changeable_price\" AS \"changeable_price\", \"street\".\"value_name\" AS \"street_name\", \"district\".\"value_name\" AS \"district_name\", \"ward\".\"value_name\" AS \"ward_name\", \"broker\".\"display_name\" AS \"broker_display_name\", \"bookmark\".\"id\" AS \"bookmark_id\", \"bookmark\".\"created_at\" AS \"bookmark_created_at\", \"bookmark\".\"updated_at\" AS \"bookmark_updated_at\", \"bookmark\".\"is_active\" AS \"bookmark_is_active\", \"bookmark\".\"property_id\" AS \"bookmark_property_id\", \"bookmark\".\"bookmarker_id\" AS \"bookmark_bookmarker_id\", \"bookmark\".\"bookmark_date\" AS \"bookmark_bookmark_date\", \"bookmark\".\"type\" AS \"bookmark_type\", \"bookmark\".\"created_by\" AS \"bookmark_created_by\", \"bookmark\".\"updated_by\" AS \"bookmark_updated_by\", \"maker\".\"display_name\" AS \"marker_display_name\", \"ratioView\".\"approved_purchase_price\" AS \"approved_purchase_price\", \"ratioView\".\"property_unit_price_ppss\" AS \"property_unit_price_ppss\", \"ratioView\".\"ratio_changeable_appraise\" AS \"ratio_changeable_appraise\", \"ratioView\".\"ratio_changeable_buy\" AS \"ratio_changeable_buy\", \"ratioView\".\"ratio_closed_deal_appraise\" AS \"ratio_closed_deal_appraise\", \"ratioView\".\"difference_price\" AS \"difference_price\", CAST(\"inspectionStatement\".\"construction\" -> 'KHTN29' AS INT) AS \"floors\", CAST(\"inspectionStatement\".\"land_use_rights\" -> 'KHNT14' AS FLOAT) AS \"horizontal_front\", CAST(\"inspectionStatement\".\"construction\" -> 'KHHT28' ->> 'value' AS BOOLEAN) AS \"has_construction\" FROM \"properties\" \"property\" LEFT JOIN \"master_values\" \"street\" ON \"street\".\"id\" = \"property\".\"street_id\"  LEFT JOIN \"master_values\" \"district\" ON \"district\".\"id\" = \"property\".\"district_id\"  LEFT JOIN \"master_values\" \"ward\" ON \"ward\".\"id\" = \"property\".\"ward_id\"  LEFT JOIN \"accounts\" \"broker\" ON \"broker\".\"id\" = \"property\".\"broker_id\"  LEFT JOIN \"property_bookmarks\" \"bookmark\" ON \"bookmark\".\"property_id\"=\"property\".\"id\"  LEFT JOIN \"accounts\" \"maker\" ON \"maker\".\"id\" = \"bookmark\".\"bookmarker_id\"  LEFT JOIN \"property_ratio_view\" \"ratioView\" ON \"ratioView\".\"id\" = \"property\".\"id\"  LEFT JOIN \"latest_approved_notes\" \"latestApprovedKH\" ON \"latestApprovedKH\".\"type\" = 'KH' AND \"latestApprovedKH\".\"property_id\" = \"property\".\"id\"  LEFT JOIN \"inspection_statement_notes\" \"inspectionStatement\" ON \"inspectionStatement\".\"id\" = \"latestApprovedKH\".\"ref_id\" WHERE \"property\".\"is_active\" = true AND \"property\".\"status\" = 'Đã duyệt'");
        await queryRunner.query("INSERT INTO \"typeorm_metadata\"(\"type\", \"schema\", \"name\", \"value\") VALUES ($1, $2, $3, $4)", ["VIEW","public","property_view","SELECT \"property\".\"id\" AS \"id\", \"property\".\"created_at\" AS \"created_at\", \"property\".\"updated_at\" AS \"updated_at\", \"property\".\"street_number\" AS \"street_number\", \"property\".\"price\" AS \"price\", \"property\".\"city_id\" AS \"city_id\", \"property\".\"ward_id\" AS \"ward_id\", \"property\".\"district_id\" AS \"district_id\", \"property\".\"street_id\" AS \"street_id\", \"property\".\"urgent_level_id\" AS \"urgent_level_id\", \"property\".\"recognized_area\" AS \"recognized_area\", \"property\".\"business_status\" AS \"business_status\", \"property\".\"status\" AS \"status\", \"property\".\"code\" AS \"code\", \"property\".\"broker_id\" AS \"broker_id\", \"property\".\"changeable_price\" AS \"changeable_price\", \"street\".\"value_name\" AS \"street_name\", \"district\".\"value_name\" AS \"district_name\", \"ward\".\"value_name\" AS \"ward_name\", \"broker\".\"display_name\" AS \"broker_display_name\", \"bookmark\".\"id\" AS \"bookmark_id\", \"bookmark\".\"created_at\" AS \"bookmark_created_at\", \"bookmark\".\"updated_at\" AS \"bookmark_updated_at\", \"bookmark\".\"is_active\" AS \"bookmark_is_active\", \"bookmark\".\"property_id\" AS \"bookmark_property_id\", \"bookmark\".\"bookmarker_id\" AS \"bookmark_bookmarker_id\", \"bookmark\".\"bookmark_date\" AS \"bookmark_bookmark_date\", \"bookmark\".\"type\" AS \"bookmark_type\", \"bookmark\".\"created_by\" AS \"bookmark_created_by\", \"bookmark\".\"updated_by\" AS \"bookmark_updated_by\", \"maker\".\"display_name\" AS \"marker_display_name\", \"ratioView\".\"approved_purchase_price\" AS \"approved_purchase_price\", \"ratioView\".\"property_unit_price_ppss\" AS \"property_unit_price_ppss\", \"ratioView\".\"ratio_changeable_appraise\" AS \"ratio_changeable_appraise\", \"ratioView\".\"ratio_changeable_buy\" AS \"ratio_changeable_buy\", \"ratioView\".\"ratio_closed_deal_appraise\" AS \"ratio_closed_deal_appraise\", \"ratioView\".\"difference_price\" AS \"difference_price\", CAST(\"inspectionStatement\".\"construction\" -> 'KHTN29' AS INT) AS \"floors\", CAST(\"inspectionStatement\".\"land_use_rights\" -> 'KHNT14' AS FLOAT) AS \"horizontal_front\", CAST(\"inspectionStatement\".\"construction\" -> 'KHHT28' ->> 'value' AS BOOLEAN) AS \"has_construction\" FROM \"properties\" \"property\" LEFT JOIN \"master_values\" \"street\" ON \"street\".\"id\" = \"property\".\"street_id\"  LEFT JOIN \"master_values\" \"district\" ON \"district\".\"id\" = \"property\".\"district_id\"  LEFT JOIN \"master_values\" \"ward\" ON \"ward\".\"id\" = \"property\".\"ward_id\"  LEFT JOIN \"accounts\" \"broker\" ON \"broker\".\"id\" = \"property\".\"broker_id\"  LEFT JOIN \"property_bookmarks\" \"bookmark\" ON \"bookmark\".\"property_id\"=\"property\".\"id\"  LEFT JOIN \"accounts\" \"maker\" ON \"maker\".\"id\" = \"bookmark\".\"bookmarker_id\"  LEFT JOIN \"property_ratio_view\" \"ratioView\" ON \"ratioView\".\"id\" = \"property\".\"id\"  LEFT JOIN \"latest_approved_notes\" \"latestApprovedKH\" ON \"latestApprovedKH\".\"type\" = 'KH' AND \"latestApprovedKH\".\"property_id\" = \"property\".\"id\"  LEFT JOIN \"inspection_statement_notes\" \"inspectionStatement\" ON \"inspectionStatement\".\"id\" = \"latestApprovedKH\".\"ref_id\" WHERE \"property\".\"is_active\" = true AND \"property\".\"status\" = 'Đã duyệt'"]);
    }

    public async down(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query("DELETE FROM \"typeorm_metadata\" WHERE \"type\" = 'VIEW' AND \"schema\" = $1 AND \"name\" = $2", ["public","property_view"]);
        await queryRunner.query("DROP VIEW \"property_view\"");
        await queryRunner.query("DELETE FROM \"typeorm_metadata\" WHERE \"type\" = 'VIEW' AND \"schema\" = $1 AND \"name\" = $2", ["public","appraisal_statement_ratio_view"]);
        await queryRunner.query("DROP VIEW \"appraisal_statement_ratio_view\"");
        await queryRunner.query("DELETE FROM \"typeorm_metadata\" WHERE \"type\" = 'VIEW' AND \"schema\" = $1 AND \"name\" = $2", ["public","property_ratio_view"]);
        await queryRunner.query("DROP VIEW \"property_ratio_view\"");
    }

}
