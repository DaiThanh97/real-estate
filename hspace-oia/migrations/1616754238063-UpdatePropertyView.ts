import { MigrationInterface, QueryRunner } from "typeorm";

export class UpdatePropertyView1616754238063 implements MigrationInterface {
  name = "UpdatePropertyView1616754238063";

  public async up(queryRunner: QueryRunner): Promise<void> {
    await queryRunner.query(`DELETE
                             FROM "typeorm_metadata"
                             WHERE "type" = 'VIEW'
                               AND "schema" = $1
                               AND "name" = $2`, ["public", "property_view"]);
    await queryRunner.query("DROP VIEW \"property_view\"");
    await queryRunner.query("CREATE VIEW \"property_view\" AS SELECT \"property\".\"id\" AS \"id\", \"property\".\"created_at\" AS \"created_at\", \"property\".\"updated_at\" AS \"updated_at\", \"property\".\"street_number\" AS \"street_number\", \"property\".\"price\" AS \"price\", \"property\".\"ward_id\" AS \"ward_id\", \"property\".\"district_id\" AS \"district_id\", \"property\".\"street_id\" AS \"street_id\", \"property\".\"urgent_level_id\" AS \"urgent_level_id\", \"property\".\"recognized_area\" AS \"recognized_area\", \"property\".\"business_status\" AS \"business_status\", \"property\".\"status\" AS \"status\", \"property\".\"code\" AS \"code\", \"property\".\"broker_id\" AS \"broker_id\", \"property\".\"changeable_price\" AS \"changeable_price\", \"street\".\"value_name\" AS \"street_name\", \"district\".\"value_name\" AS \"district_name\", \"ward\".\"value_name\" AS \"ward_name\", \"broker\".\"display_name\" AS \"broker_display_name\", \"bookmark\".\"id\" AS \"bookmark_id\", \"bookmark\".\"created_at\" AS \"bookmark_created_at\", \"bookmark\".\"updated_at\" AS \"bookmark_updated_at\", \"bookmark\".\"is_active\" AS \"bookmark_is_active\", \"bookmark\".\"property_id\" AS \"bookmark_property_id\", \"bookmark\".\"bookmarker_id\" AS \"bookmark_bookmarker_id\", \"bookmark\".\"bookmark_date\" AS \"bookmark_bookmark_date\", \"bookmark\".\"type\" AS \"bookmark_type\", \"bookmark\".\"created_by\" AS \"bookmark_created_by\", \"bookmark\".\"updated_by\" AS \"bookmark_updated_by\", \"maker\".\"display_name\" AS \"marker_display_name\", \"ratioView\".\"approved_purchase_price\" AS \"approved_purchase_price\", \"ratioView\".\"property_unit_price_ppss\" AS \"property_unit_price_ppss\", \"ratioView\".\"ratio_changeable_appraise\" AS \"ratio_changeable_appraise\", \"ratioView\".\"ratio_changeable_buy\" AS \"ratio_changeable_buy\", \"ratioView\".\"ratio_closed_deal_appraise\" AS \"ratio_closed_deal_appraise\", \"ratioView\".\"difference_price\" AS \"difference_price\", \"inspectionStatement\".\"construction\" -> 'KHTN29' AS \"floors\", \"inspectionStatement\".\"land_use_rights\" -> 'KHNT14' AS \"horizontal_front\" FROM \"properties\" \"property\" LEFT JOIN \"master_values\" \"street\" ON \"street\".\"id\" = \"property\".\"street_id\"  LEFT JOIN \"master_values\" \"district\" ON \"district\".\"id\" = \"property\".\"district_id\"  LEFT JOIN \"master_values\" \"ward\" ON \"ward\".\"id\" = \"property\".\"ward_id\"  LEFT JOIN \"accounts\" \"broker\" ON \"broker\".\"id\" = \"property\".\"broker_id\"  LEFT JOIN \"property_bookmarks\" \"bookmark\" ON \"bookmark\".\"property_id\"=\"property\".\"id\"  LEFT JOIN \"accounts\" \"maker\" ON \"maker\".\"id\" = \"bookmark\".\"bookmarker_id\"  LEFT JOIN \"property_ratio_view\" \"ratioView\" ON \"ratioView\".\"id\" = \"property\".\"id\"  LEFT JOIN \"latest_approved_notes\" \"latestApprovedKH\" ON \"latestApprovedKH\".\"type\" = 'KH' AND \"latestApprovedKH\".\"property_id\" = \"property\".\"id\"  LEFT JOIN \"inspection_statement_notes\" \"inspectionStatement\" ON \"inspectionStatement\".\"id\" = \"latestApprovedKH\".\"ref_id\" WHERE \"property\".\"is_active\" = true AND \"property\".\"status\" = 'Đã duyệt'");
    await queryRunner.query(`INSERT INTO "typeorm_metadata"("type", "schema", "name", "value")
                             VALUES ($1, $2, $3, $4)`, ["VIEW", "public", "property_view", "SELECT \"property\".\"id\" AS \"id\", \"property\".\"created_at\" AS \"created_at\", \"property\".\"updated_at\" AS \"updated_at\", \"property\".\"street_number\" AS \"street_number\", \"property\".\"price\" AS \"price\", \"property\".\"ward_id\" AS \"ward_id\", \"property\".\"district_id\" AS \"district_id\", \"property\".\"street_id\" AS \"street_id\", \"property\".\"urgent_level_id\" AS \"urgent_level_id\", \"property\".\"recognized_area\" AS \"recognized_area\", \"property\".\"business_status\" AS \"business_status\", \"property\".\"status\" AS \"status\", \"property\".\"code\" AS \"code\", \"property\".\"broker_id\" AS \"broker_id\", \"property\".\"changeable_price\" AS \"changeable_price\", \"street\".\"value_name\" AS \"street_name\", \"district\".\"value_name\" AS \"district_name\", \"ward\".\"value_name\" AS \"ward_name\", \"broker\".\"display_name\" AS \"broker_display_name\", \"bookmark\".\"id\" AS \"bookmark_id\", \"bookmark\".\"created_at\" AS \"bookmark_created_at\", \"bookmark\".\"updated_at\" AS \"bookmark_updated_at\", \"bookmark\".\"is_active\" AS \"bookmark_is_active\", \"bookmark\".\"property_id\" AS \"bookmark_property_id\", \"bookmark\".\"bookmarker_id\" AS \"bookmark_bookmarker_id\", \"bookmark\".\"bookmark_date\" AS \"bookmark_bookmark_date\", \"bookmark\".\"type\" AS \"bookmark_type\", \"bookmark\".\"created_by\" AS \"bookmark_created_by\", \"bookmark\".\"updated_by\" AS \"bookmark_updated_by\", \"maker\".\"display_name\" AS \"marker_display_name\", \"ratioView\".\"approved_purchase_price\" AS \"approved_purchase_price\", \"ratioView\".\"property_unit_price_ppss\" AS \"property_unit_price_ppss\", \"ratioView\".\"ratio_changeable_appraise\" AS \"ratio_changeable_appraise\", \"ratioView\".\"ratio_changeable_buy\" AS \"ratio_changeable_buy\", \"ratioView\".\"ratio_closed_deal_appraise\" AS \"ratio_closed_deal_appraise\", \"ratioView\".\"difference_price\" AS \"difference_price\", \"inspectionStatement\".\"construction\" -> 'KHTN29' AS \"floors\", \"inspectionStatement\".\"land_use_rights\" -> 'KHNT14' AS \"horizontal_front\" FROM \"properties\" \"property\" LEFT JOIN \"master_values\" \"street\" ON \"street\".\"id\" = \"property\".\"street_id\"  LEFT JOIN \"master_values\" \"district\" ON \"district\".\"id\" = \"property\".\"district_id\"  LEFT JOIN \"master_values\" \"ward\" ON \"ward\".\"id\" = \"property\".\"ward_id\"  LEFT JOIN \"accounts\" \"broker\" ON \"broker\".\"id\" = \"property\".\"broker_id\"  LEFT JOIN \"property_bookmarks\" \"bookmark\" ON \"bookmark\".\"property_id\"=\"property\".\"id\"  LEFT JOIN \"accounts\" \"maker\" ON \"maker\".\"id\" = \"bookmark\".\"bookmarker_id\"  LEFT JOIN \"property_ratio_view\" \"ratioView\" ON \"ratioView\".\"id\" = \"property\".\"id\"  LEFT JOIN \"latest_approved_notes\" \"latestApprovedKH\" ON \"latestApprovedKH\".\"type\" = 'KH' AND \"latestApprovedKH\".\"property_id\" = \"property\".\"id\"  LEFT JOIN \"inspection_statement_notes\" \"inspectionStatement\" ON \"inspectionStatement\".\"id\" = \"latestApprovedKH\".\"ref_id\" WHERE \"property\".\"is_active\" = true AND \"property\".\"status\" = 'Đã duyệt'"]);
  }

  public async down(queryRunner: QueryRunner): Promise<void> {
    await queryRunner.query(`DELETE
                             FROM "typeorm_metadata"
                             WHERE "type" = 'VIEW'
                               AND "schema" = $1
                               AND "name" = $2`, ["public", "property_view"]);
    await queryRunner.query("DROP VIEW \"property_view\"");
    await queryRunner.query("CREATE VIEW \"property_view\" AS SELECT \"property\".\"id\" AS \"id\", \"property\".\"updated_at\" AS \"updated_at\", \"property\".\"street_number\" AS \"street_number\", \"property\".\"price\" AS \"price\", \"property\".\"ward_id\" AS \"ward_id\", \"property\".\"district_id\" AS \"district_id\", \"property\".\"street_id\" AS \"street_id\", \"property\".\"business_status\" AS \"business_status\", \"property\".\"status\" AS \"status\", \"property\".\"code\" AS \"code\", \"property\".\"broker_id\" AS \"broker_id\", \"property\".\"changeable_price\" AS \"changeable_price\", \"street\".\"value_name\" AS \"street_name\", \"district\".\"value_name\" AS \"district_name\", \"ward\".\"value_name\" AS \"ward_name\", \"broker\".\"display_name\" AS \"broker_display_name\", \"bookmark\".\"id\" AS \"bookmark_id\", \"bookmark\".\"created_at\" AS \"bookmark_created_at\", \"bookmark\".\"updated_at\" AS \"bookmark_updated_at\", \"bookmark\".\"is_active\" AS \"bookmark_is_active\", \"bookmark\".\"property_id\" AS \"bookmark_property_id\", \"bookmark\".\"bookmarker_id\" AS \"bookmark_bookmarker_id\", \"bookmark\".\"bookmark_date\" AS \"bookmark_bookmark_date\", \"bookmark\".\"type\" AS \"bookmark_type\", \"bookmark\".\"created_by\" AS \"bookmark_created_by\", \"bookmark\".\"updated_by\" AS \"bookmark_updated_by\", \"maker\".\"display_name\" AS \"marker_display_name\" FROM \"properties\" \"property\" LEFT JOIN \"master_values\" \"street\" ON \"street\".\"id\" = \"property\".\"street_id\"  LEFT JOIN \"master_values\" \"district\" ON \"district\".\"id\" = \"property\".\"district_id\"  LEFT JOIN \"master_values\" \"ward\" ON \"ward\".\"id\" = \"property\".\"ward_id\"  LEFT JOIN \"accounts\" \"broker\" ON \"broker\".\"id\" = \"property\".\"broker_id\"  LEFT JOIN \"property_bookmarks\" \"bookmark\" ON \"bookmark\".\"property_id\"=\"property\".\"id\"  LEFT JOIN \"accounts\" \"maker\" ON \"maker\".\"id\" = \"bookmark\".\"bookmarker_id\" WHERE \"property\".\"is_active\" = true AND \"property\".\"status\" = 'Đã duyệt'");
    await queryRunner.query(`INSERT INTO "typeorm_metadata"("type", "schema", "name", "value")
                             VALUES ($1, $2, $3, $4)`, ["VIEW", "public", "property_view", "SELECT \"property\".\"id\" AS \"id\", \"property\".\"updated_at\" AS \"updated_at\", \"property\".\"street_number\" AS \"street_number\", \"property\".\"price\" AS \"price\", \"property\".\"ward_id\" AS \"ward_id\", \"property\".\"district_id\" AS \"district_id\", \"property\".\"street_id\" AS \"street_id\", \"property\".\"business_status\" AS \"business_status\", \"property\".\"status\" AS \"status\", \"property\".\"code\" AS \"code\", \"property\".\"broker_id\" AS \"broker_id\", \"property\".\"changeable_price\" AS \"changeable_price\", \"street\".\"value_name\" AS \"street_name\", \"district\".\"value_name\" AS \"district_name\", \"ward\".\"value_name\" AS \"ward_name\", \"broker\".\"display_name\" AS \"broker_display_name\", \"bookmark\".\"id\" AS \"bookmark_id\", \"bookmark\".\"created_at\" AS \"bookmark_created_at\", \"bookmark\".\"updated_at\" AS \"bookmark_updated_at\", \"bookmark\".\"is_active\" AS \"bookmark_is_active\", \"bookmark\".\"property_id\" AS \"bookmark_property_id\", \"bookmark\".\"bookmarker_id\" AS \"bookmark_bookmarker_id\", \"bookmark\".\"bookmark_date\" AS \"bookmark_bookmark_date\", \"bookmark\".\"type\" AS \"bookmark_type\", \"bookmark\".\"created_by\" AS \"bookmark_created_by\", \"bookmark\".\"updated_by\" AS \"bookmark_updated_by\", \"maker\".\"display_name\" AS \"marker_display_name\" FROM \"properties\" \"property\" LEFT JOIN \"master_values\" \"street\" ON \"street\".\"id\" = \"property\".\"street_id\"  LEFT JOIN \"master_values\" \"district\" ON \"district\".\"id\" = \"property\".\"district_id\"  LEFT JOIN \"master_values\" \"ward\" ON \"ward\".\"id\" = \"property\".\"ward_id\"  LEFT JOIN \"accounts\" \"broker\" ON \"broker\".\"id\" = \"property\".\"broker_id\"  LEFT JOIN \"property_bookmarks\" \"bookmark\" ON \"bookmark\".\"property_id\"=\"property\".\"id\"  LEFT JOIN \"accounts\" \"maker\" ON \"maker\".\"id\" = \"bookmark\".\"bookmarker_id\" WHERE \"property\".\"is_active\" = true AND \"property\".\"status\" = 'Đã duyệt'"]);
  }

}
